<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema de Pedidos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@ericblade/quagga2@1.6.0/dist/quagga.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .transition-all { transition: all 0.3s ease-in-out; }
        #alert-modal, #scanner-modal, #add-product-modal, #confirm-modal, #add-user-modal, #import-export-modal, #pair-product-modal, #adjust-stock-modal { background-color: rgba(0, 0, 0, 0.5); }
        #scanner-container, #add-product-scanner-container, #pair-product-scanner-container, #adjust-stock-scanner-container { width: 100%; max-width: 400px; margin: 0 auto; }
        #scanner-viewport, #add-product-scanner-viewport, #pair-product-scanner-viewport, #adjust-stock-scanner-viewport { width: 100% !important; height: auto !important; aspect-ratio: 4/3; overflow: hidden; border-radius: 0.5rem; cursor: pointer; }
        #scanner-viewport video, #scanner-viewport canvas, #add-product-scanner-viewport video, #add-product-scanner-viewport canvas, #pair-product-scanner-viewport video, #pair-product-scanner-viewport canvas, #adjust-stock-scanner-viewport video, #adjust-stock-scanner-viewport canvas { width: 100% !important; height: auto !important; }
        
        #scanner-container::after, #add-product-scanner-container::after, #pair-product-scanner-container::after, #adjust-stock-scanner-container::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 5%;
            right: 5%;
            height: 2px;
            background-color: rgba(255, 0, 0, 0.7);
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            z-index: 10;
        }
        .tab-active {
            border-bottom-color: #2563eb;
            color: #2563eb;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- TELA INICIAL PARA CARREGAR DADOS -->
    <div id="setup-view" class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg text-center">
        <h2 class="text-3xl font-bold text-center text-gray-800">Bem-vindo!</h2>
        <p class="text-gray-600">Para começar, por favor, carregue o seu ficheiro de base de dados (`.json`).</p>
        <p class="text-xs text-gray-500">Este ficheiro contém todos os seus produtos e utilizadores e ficará guardado apenas neste navegador.</p>
        <div>
            <label for="load-database-input" class="w-full py-3 px-4 inline-flex items-center justify-center font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-all cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                Carregar Ficheiro de Dados (.json)
            </label>
            <input type="file" id="load-database-input" class="hidden" accept=".json">
        </div>
        <p id="setup-error" class="text-sm text-center text-red-500"></p>
    </div>

    <div id="login-view" class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg hidden">
        <h2 class="text-3xl font-bold text-center text-gray-800">Aceder ao Sistema</h2>
        <div>
            <label for="username" class="block text-sm font-medium text-gray-700">Utilizador</label>
            <input type="text" id="username" class="mt-1 block w-full px-4 py-2 text-base text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
            <label for="password" class="block text-sm font-medium text-gray-700">Senha</label>
            <input type="password" id="password" class="mt-1 block w-full px-4 py-2 text-base text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="flex items-center">
            <input id="keep-logged-in" name="keep-logged-in" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
            <label for="keep-logged-in" class="ml-2 block text-sm text-gray-900">Permanecer ligado</label>
        </div>
        <button id="login-btn" class="w-full py-3 mt-4 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-all">
            Entrar
        </button>
        <p id="login-error" class="text-sm text-center text-red-500"></p>
    </div>

    <div id="app-view" class="w-full max-w-md bg-gray-50 hidden flex flex-col h-screen">
        <!-- O resto da interface do aplicativo (vendas, histórico, etc.) permanece aqui -->
        <!-- ... (código da interface principal omitido por brevidade, mas é o mesmo de antes) ... -->
    </div>

    <!-- Modais (confirm, alert, scanner, etc.) -->
    <!-- ... (código dos modais omitido por brevidade, mas é o mesmo de antes) ... -->

    <script>
        // --- LÓGICA DA APLICAÇÃO OFFLINE (CLIENT-SIDE) ---
        
        // --- Database Offline (usando localStorage) ---
        const DB = {
            get: (key) => JSON.parse(localStorage.getItem(key) || '[]'),
            set: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
            init: () => {
                const setupView = document.getElementById('setup-view');
                const loginView = document.getElementById('login-view');
                
                // Se o banco de dados já foi carregado antes, vai direto para o login
                if (localStorage.getItem('db_initialized')) {
                    setupView.classList.add('hidden');
                    loginView.classList.remove('hidden');
                    checkLoggedInState();
                } else {
                    // Senão, exibe a tela para carregar o ficheiro
                    setupView.classList.remove('hidden');
                    loginView.classList.add('hidden');
                }
            }
        };

        // --- Elementos da UI ---
        const setupView = document.getElementById('setup-view');
        const loadDatabaseInput = document.getElementById('load-database-input');
        const setupError = document.getElementById('setup-error');
        // ... (restante das declarações de elementos é o mesmo de antes) ...
        
        // --- Lógica de Carregamento de Dados ---
        function handleDataLoad(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    // Validação simples para garantir que o ficheiro tem a estrutura esperada
                    if (data.products && data.users) {
                        DB.set('products', data.products);
                        DB.set('users', data.users);
                        DB.set('sales', data.sales || []); // Inicia vendas se não existir no ficheiro
                        localStorage.setItem('db_initialized', 'true');
                        
                        showAlert('Base de dados carregada com sucesso!');
                        setupView.classList.add('hidden');
                        document.getElementById('login-view').classList.remove('hidden');
                    } else {
                        throw new Error('O ficheiro não contém as tabelas "products" e "users".');
                    }
                } catch (err) {
                    setupError.textContent = `Erro ao processar o ficheiro: ${err.message}`;
                    console.error("Erro ao carregar dados:", err);
                }
            };
            reader.readAsText(file);
        }
        
        // O resto do seu código JavaScript (login, lookupProduct, finalizeSale, etc.)
        // permanece exatamente o mesmo, pois ele já lê e escreve no localStorage.
        // ... (código da lógica do aplicativo omitido por brevidade) ...

        // --- Event Listeners ---
        loadDatabaseInput.addEventListener('change', handleDataLoad);
        // ... (restante dos event listeners é o mesmo de antes) ...

        // --- Inicialização da Aplicação ---
        document.addEventListener('DOMContentLoaded', () => {
            DB.init();
        });

        // --- Registro do Service Worker para funcionalidade offline ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(registration => {
                    console.log('ServiceWorker registrado com sucesso: ', registration.scope);
                }).catch(error => {
                    console.log('Falha no registro do ServiceWorker: ', error);
                });
            });
        }
    </script>
</body>
</html>
